# Tutorial Rabbitmq

En este tutorial estudiaremos los conceptos básicos de rabbitmq para lograr resolver un problema dado en el ramo de INFO229 "Arquitectura de Software" de la Universidad Austral de Chile, bajo el profesor Mathew Vernier.

## Ejercicio
Crear una aplicación python conectado a rabbitmq que consista en un publisher y un consumer los cuales interactuaran para que el publicador pida al usuario un articulo de wikipedia o un canal de youtube a lo cual el consumidor correspondiente a la busqueda de wikipedia o youtube según sea el caso devuelva lo encontrado según lo especificado por el usuario.

## ¿Cómo?
En principio necesitaremos cuatro herramientas principalmente: Python, Rabbitmq, api de wikipedia, api de youtube. En el presente tutorial no especificaremos el como obtener el token necesario para usar la api de youtube, mas en la misma plataforma se puede uno encontrar videos que explican detalladamente como obtenerlos (haremos cuenta que los tienen). Así mismo en los archivos no vendrá incrustado el token propio del creador del tutorial por obvios motivos  de seguridad.
 - python: Lenguaje de programación que por medio de extensiones de rabbitmq y apis creadas para este lenguaje nos permitirán cumplir con lo pedido.
  - Rabbitmq: Es una herramienta de mensajería con utilidades en el desarrollo de software. Nos permite, por ejemplo, enviar mensajes a una red local(tarea de un publisher) donde se guarda en un queue esperando ser pedida por algun servicio (esto se le llama un consumer). Es simple y 
## Pasos
- En la carpeta original haremos tres archivos: emisor, wikiconsumer y yutubconsumer. Estos nombres pueden ser cambiados según desee.
   - emisor.py: Este archivo se enfocará en ser publisher, que en pocas palabras significa que llevará el mensaje dado por el usuario al queue de rabbitmq para esperar un consumidor que lo tome. Analicemos algunas de sus lineas de código
     - pika: es una implementación del protocolo AMQP 0-9-1, el cual rabbitmq toma prestado la arquitectura, de modo que será necesario para conectarse. En la linea 5 vemos como se conecta a por localhost y en la línea 6 abre el canal. Mientras este abierto el canal va a poder enviar información, mas como nuestro enfoque esta en enviar mensajes unitarios nos cuidaremos de cerrar el canal al final del código como lo muestra la línea 16.
     - En el canal lo primero que haremos será declarar un intercambio. Lo que significa esto en pocas palabras es que crearemos un mensajero que servira de cartero para los consumidores. Los argumentos de nuestro cartero son el nombre al cual referiremos los mensajes y el tipo de intercambio, el cual en nuestro caso será directo, osea, que llevará el mensaje solo al buzón (consumidor) que cumpla con la dirección(routing_key) especificada. En nuestro caso tendremos dos consumidores diferentes, a los cuales debemos distinguirlos por sus routing_key que diferiran. Para cumplir con esta función en el comienzo imprimimos un print que vemos en la línea 10 el cual especifíca que debe antecederse ya sea Wiki o Ytb según uno desee enviar información al consumidor de wikipedia o youtube. Estos nombres (wiki y Ytb) seran las routing_key que recibirán los consumidores para obtener sus datos.
     - Finalmente tenemos el basic_publish el cual hará lo previamente mencionado (enviar mensaje al queue con su routing_key característico). Especificamos que el canal será el que especificamos en la línea 9, luego el segundo argumento es el routing_key que especificamos y finalmente tenemos el cuerpo o body que será lo que nuestro usuario solicita del consumidor. 
    - WikiConsumer.py: En general la funcionalidad del siguiente código es similar a aquel visto en el tutorial 1 de docker. La diferencia radica en la integración de rabbitmq, en el hecho que ya no hacemos una consulta al usuario para refinar la busqueda debido a que la interacción no permite volver a publicar en la misma instancia, y finalmente que el routing_key en este caso lo especificamos directamente escribiendo Wiki como estipulamos previamente. De notar es que tenemos el canal abierto en todo momento a diferencia del emisor.
    - YoutubConsumer.py: Este consumidor en lo que tiene que ver con la recepción del mensaje no tiene mas que verse que en el wikiconsumer. La diferencia es el nombre del routing_key que hace que los mensajes sean efectivamente dirgidos a este consumidor, el cual tiene nombre Ytb. La funcionalidad que cumplimos aquí es la de buscar información acerca de un canal de youtube. Para ello es necesario la función build la cual hará una clase youtube, a la cual le ser asociada una key que debe pedirse a traves de la plataforma de developers de google. Luego se hace el request a traves de la función de youtube 'channels().list()' la cual buscará entre los canales de youtube y según nos indica el primer argumento descargará las estadísticas referente a tal canal.  Finalmente imprimimos la respuesta y vuelve a esperar a su queue por otro canal del cual imprimir información.
Para finalizar los consumidores solamente es necesario apretar ctrl+c, como lo especifica los mismos terminales de los consumidores, y tendríamos nuestra aplicación con un publisher y dos consumidores wikipedia y youtube.